@model OKRPerformanceManagement.Models.PerformanceReview

@if (Model?.Objectives != null && Model.Objectives.Any())
{
    <div class="table-responsive" style="font-size: 0.85rem;">
        <table class="table table-bordered table-striped table-sm">
            <thead class="thead-dark">
                <tr>
                    <th rowspan="2" style="min-width: 200px;">Objective</th>
                    <th rowspan="2" class="text-center">KR Weight</th>
                    <th rowspan="2" style="min-width: 150px;">OKR Name</th>
                    <th rowspan="2" style="min-width: 150px;">Target</th>
                    <th rowspan="2" style="min-width: 200px;">Measure</th>
                    <th rowspan="2" style="min-width: 200px;">Objectives</th>
                    <th rowspan="2" style="min-width: 200px;">Measurement/Tracking Source</th>
                    <th rowspan="2" class="text-center">Final Weighting</th>
                    <th colspan="3" class="text-center">Rating - Manager</th>
                    <th colspan="3" class="text-center">Rating Employee</th>
                    <th colspan="3" class="text-center">Final Rating</th>
                    <th rowspan="2" style="min-width: 150px;">Comments</th>
                </tr>
                <tr>
                    <!-- Manager Rating Columns -->
                    <th class="text-center">Rating</th>
                    <th class="text-center">% Based on Value</th>
                    <th class="text-center">Calc</th>
                    <!-- Employee Rating Columns -->
                    <th class="text-center">Rating</th>
                    <th class="text-center">% Based on Value</th>
                    <th class="text-center">Calc</th>
                    <!-- Final Rating Columns -->
                    <th class="text-center">Rating</th>
                    <th class="text-center">% Based on Value</th>
                    <th class="text-center">Calc</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var objective in Model.Objectives.OrderBy(o => o.SortOrder))
                {
                    var keyResultsCount = objective.KeyResults?.Count ?? 1;
                    var keyResultsList = objective.KeyResults?.OrderBy(k => k.SortOrder).ToList() ?? new List<OKRPerformanceManagement.Models.KeyResult>();
                    
                    @foreach (var kr in keyResultsList)
                    {
                        // Calculate Manager values
                        var managerRating = kr.ManagerRating ?? 0;
                        var managerPercentValue = managerRating > 0 ? (managerRating / 5.0) * 100 : 0;
                        var managerCalc = managerRating > 0 ? (managerPercentValue / 100.0) * (double)kr.Weight : 0;

                        // Calculate Employee values
                        var employeeRating = kr.EmployeeRating ?? 0;
                        var employeePercentValue = employeeRating > 0 ? (employeeRating / 5.0) * 100 : 0;
                        var employeeCalc = employeeRating > 0 ? (employeePercentValue / 100.0) * (double)kr.Weight : 0;

                        // Calculate Final values
                        var finalRating = kr.FinalRating ?? 0;
                        var finalPercentValue = finalRating > 0 ? (finalRating / 5.0) * 100 : 0;
                        var finalCalc = finalRating > 0 ? (finalPercentValue / 100.0) * (double)kr.Weight : 0;

                        <tr>
                            @if (kr == keyResultsList.First())
                            {
                                <td rowspan="@keyResultsCount" class="align-middle" style="vertical-align: middle;">
                                    <strong>@objective.Name</strong>
                                </td>
                                <td rowspan="@keyResultsCount" class="align-middle text-center" style="vertical-align: middle;">
                                    @objective.Weight.ToString("F2")%
                                </td>
                            }
                            <td>@kr.Name</td>
                            <td>@kr.Target</td>
                            <td style="white-space: pre-wrap; font-size: 0.8rem;">@kr.Measure</td>
                            <td style="white-space: pre-wrap; font-size: 0.8rem;">@kr.Objectives</td>
                            <td style="white-space: pre-wrap; font-size: 0.8rem;">@kr.MeasurementSource</td>
                            <td class="text-center">@kr.Weight.ToString("F2")%</td>
                            
                            <!-- Manager Rating Columns -->
                            <td class="text-center">
                                @if (kr.ManagerRating.HasValue)
                                {
                                    <span class="badge bg-info text-white">@kr.ManagerRating.Value</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (kr.ManagerRating.HasValue)
                                {
                                    <span>@managerPercentValue.ToString("F2")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (kr.ManagerRating.HasValue)
                                {
                                    <span>@managerCalc.ToString("F2")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            
                            <!-- Employee Rating Columns -->
                            <td class="text-center">
                                @if (kr.EmployeeRating.HasValue)
                                {
                                    <span class="badge bg-warning text-white">@kr.EmployeeRating.Value</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (kr.EmployeeRating.HasValue)
                                {
                                    <span>@employeePercentValue.ToString("F2")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (kr.EmployeeRating.HasValue)
                                {
                                    <span>@employeeCalc.ToString("F2")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            
                            <!-- Final Rating Columns -->
                            <td class="text-center">
                                @if (kr.FinalRating.HasValue)
                                {
                                    <span class="badge bg-success text-white">@kr.FinalRating.Value</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (kr.FinalRating.HasValue)
                                {
                                    <span>@finalPercentValue.ToString("F2")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (kr.FinalRating.HasValue)
                                {
                                    <span>@finalCalc.ToString("F2")%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            
                            <td style="white-space: pre-wrap; font-size: 0.8rem;">@(kr.FinalComments ?? kr.ManagerComments ?? kr.EmployeeComments ?? "")</td>
                        </tr>
                    }
                }
            </tbody>
            <tfoot>
                <tr class="table-info">
                    <td colspan="7" class="text-right"><strong>Must add up to 100</strong></td>
                    <td class="text-center"><strong>100.00%</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tfoot>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No Objectives Found
    </div>
}

